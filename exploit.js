console.log('Loading...')
const port = 80
const express = require('express');
const mongoose = require('mongoose');
const bodyParser = require('body-parser');
const { check, validationResult } = require('express-validator')
const flash = require('connect-flash')
const session = require('express-session');
const passport = require('passport');
require('./config/passport')(passport);
require('dotenv/config');
const app = express();

app.use(bodyParser.json());

//ASSETS
app.use('/assets', express.static(__dirname + '/assets'))

//SESSION
app.use(session({
    secret: 'secret',
    resave: true,
    saveUninitialized: true
}))

//PASSPORT
app.use(passport.initialize())
app.use(passport.session())

//CONNECT FLASH
app.use(flash())

//ROUTES
app.use('/', require('./routes/index.js'));
app.use('/api', require("./routes/api-endpoint"));
app.use('/users', require('./routes/loginapi'));
app.use('/versions', require('./routes/versions'));
app.get('*', async(req, res) => {
    res.render('404')
})
app.post('*', async(req, res) => {
    res.render('404')
})

//TEMPLATING ENGINE
app.set('views', './views')
app.set('view engine', 'ejs')

//DB CONNECT
mongoose.connect(
    process.env.DB_CONNECTION,
    { useNewUrlParser: true, useUnifiedTopology: true, useFindAndModify: false },
    () => console.log('MongoDB connectet!')
);

//PORT
app.listen(port);
console.log('API Online!')